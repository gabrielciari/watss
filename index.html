<?php
session_start();

/* üéØ CONEX√ÉO COM O BANCO DE DADOS */
$host = 'localhost';
$db   = 'shopon';
$user = 'root';
$pass = '';
try {
    $pdo = new PDO("mysql:host=$host;dbname=$db;charset=utf8", $user, $pass);
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    die("Erro na conex√£o: " . $e->getMessage());
}

/* ‚úÖ LOGIN */
if (isset($_POST['acao']) && $_POST['acao'] == 'login') {
    $email = $_POST['email'];
    $senha = $_POST['senha'];

    $stmt = $pdo->prepare("SELECT * FROM usuarios WHERE email = ?");
    $stmt->execute([$email]);
    $usuario = $stmt->fetch();

    if ($usuario && password_verify($senha, $usuario['senha'])) {
        $_SESSION['usuario_id'] = $usuario['id'];
        $_SESSION['usuario'] = $usuario['nome'];
        echo json_encode(['status' => 'success', 'message' => '‚úÖ Login realizado!']);
        exit;
    } else {
        echo json_encode(['status' => 'error', 'message' => '‚ùå Email ou senha inv√°lidos!']);
        exit;
    }
}

/* ‚úÖ CADASTRO */
if (isset($_POST['acao']) && $_POST['acao'] == 'cadastro') {
    $nome = $_POST['nome'];
    $email = $_POST['email'];
    $senha = password_hash($_POST['senha'], PASSWORD_DEFAULT);

    $stmt = $pdo->prepare("INSERT INTO usuarios (nome, email, senha) VALUES (?, ?, ?)");
    $stmt->execute([$nome, $email, $senha]);

    echo json_encode(['status' => 'success', 'message' => '‚úÖ Cadastro realizado!']);
    exit;
}

/* ‚úÖ LOGOUT */
if (isset($_GET['logout'])) {
    session_destroy();
    header("Location: index.php");
    exit;
}

/* ‚úÖ ADICIONAR AO CARRINHO */
if (isset($_POST['acao']) && $_POST['acao'] == 'add_carrinho') {
    if (!isset($_SESSION['usuario_id'])) {
        echo "<script>alert('‚ö†Ô∏è Fa√ßa login para adicionar itens!');</script>";
    } else {
        $usuario_id = $_SESSION['usuario_id'];
        $produto_id = $_POST['produto_id'];

        $sql = "SELECT * FROM carrinho WHERE usuario_id = ? AND produto_id = ?";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([$usuario_id, $produto_id]);

        if ($stmt->rowCount() > 0) {
            $pdo->prepare("UPDATE carrinho SET quantidade = quantidade + 1 WHERE usuario_id = ? AND produto_id = ?")
                ->execute([$usuario_id, $produto_id]);
        } else {
            $pdo->prepare("INSERT INTO carrinho (usuario_id, produto_id, quantidade) VALUES (?, ?, 1)")
                ->execute([$usuario_id, $produto_id]);
        }
        echo "<script>alert('‚úÖ Produto adicionado ao carrinho!');</script>";
    }
}

/* ‚úÖ FINALIZAR PEDIDO */
if (isset($_POST['acao']) && $_POST['acao'] == 'finalizar') {
    $usuario_id = $_SESSION['usuario_id'];
    $stmt = $pdo->prepare("SELECT * FROM carrinho WHERE usuario_id = ?");
    $stmt->execute([$usuario_id]);
    $itens = $stmt->fetchAll(PDO::FETCH_ASSOC);

    if (count($itens) > 0) {
        $total = 0;
        foreach ($itens as $item) {
            $p = $pdo->prepare("SELECT preco FROM produtos WHERE id = ?");
            $p->execute([$item['produto_id']]);
            $preco = $p->fetchColumn();
            $total += $preco * $item['quantidade'];
        }

        $pdo->prepare("INSERT INTO pedidos (usuario_id, total) VALUES (?, ?)")->execute([$usuario_id, $total]);
        $pedido_id = $pdo->lastInsertId();

        foreach ($itens as $item) {
            $p = $pdo->prepare("SELECT preco FROM produtos WHERE id = ?");
            $p->execute([$item['produto_id']]);
            $preco = $p->fetchColumn();

            $pdo->prepare("INSERT INTO pedido_itens (pedido_id, produto_id, quantidade, preco) VALUES (?, ?, ?, ?)")
                ->execute([$pedido_id, $item['produto_id'], $item['quantidade'], $preco]);
        }

        $pdo->prepare("DELETE FROM carrinho WHERE usuario_id = ?")->execute([$usuario_id]);
        echo "<script>alert('‚úÖ Pedido finalizado com sucesso!');</script>";
    }
}
?>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHOP ON BRASIL</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
  body {margin: 0; font-family: Arial, sans-serif; background-color: #f5f5f5;}
  header {background-color: #111; padding: 10px 20px; color: white; display: flex; align-items: center; justify-content: space-between;}
  header .logo {font-size: 24px; font-weight: bold;}
  header .logo span {background: red; padding: 3px 6px; border-radius: 3px;}
  .search-bar {flex: 1; margin: 0 20px;}
  .search-bar input {width: 100%; padding: 8px; border-radius: 5px; border: none;}
  .icons i {margin-left: 15px; cursor: pointer;}
  nav {background-color: #222; padding: 10px; text-align: center;}
  nav a {color: white; margin: 0 15px; text-decoration: none; font-weight: bold;}
  .banner {background-color: red; color: white; padding: 30px; text-align: center; font-size: 24px; font-weight: bold;}
  .categorias {display: flex; justify-content: center; padding: 20px; gap: 15px;}
  .categorias div {background: white; padding: 15px; border-radius: 10px; text-align: center; width: 100px; box-shadow: 0 0 5px rgba(0,0,0,0.1);}
  .produtos {display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 20px;}
  .produto {background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 0 5px rgba(0,0,0,0.1);}
  .produto img {max-width: 100%; height: 150px; object-fit: contain;}
  .produto button {background-color: red; color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; margin-top: 10px; cursor: pointer; font-weight: bold;}
  footer {background: #111; color: white; text-align: center; padding: 20px; margin-top: 20px;}
  .whatsapp-btn {position: fixed; bottom: 20px; right: 20px; background: #25D366; color: white; padding: 15px; border-radius: 50%; font-size: 24px; box-shadow: 0 0 10px rgba(0,0,0,0.3);}
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<header>
  <div class="logo">SHOP <span>ON</span> BRASIL</div>
  <div class="search-bar">
    <input type="text" placeholder="Buscar produtos...">
  </div>
  <div class="icons">
    <?php if(isset($_SESSION['usuario'])): ?>
      üë§ Ol√°, <strong><?php echo $_SESSION['usuario']; ?></strong>
      <a href="?logout=1" style="color:red; margin-left:10px;">[Sair]</a>
    <?php else: ?>
      <i class="fas fa-user" onclick="document.getElementById('loginModal').style.display='block'"></i>
    <?php endif; ?>
    <i class="fas fa-shopping-cart"></i>
  </div>
</header>

<nav>
  <a href="#">Roupas</a>
  <a href="#">Acess√≥rios</a>
  <a href="#">Games</a>
  <a href="#">Casa</a>
</nav>

<div class="banner">GANHE CUPONS - MELHORES OFERTAS DO DIA</div>

<div class="categorias">
  <div>üëï<br>Roupas</div>
  <div>‚åö<br>Acess√≥rios</div>
  <div>üéÆ<br>Games</div>
  <div>üè†<br>Casa</div>
</div>

<section class="produtos">
  <form method="POST">
    <input type="hidden" name="acao" value="add_carrinho">
    <input type="hidden" name="produto_id" value="1">
    <div class="produto">
      <img src="https://via.placeholder.com/150" alt="Produto 1">
      <h3>Moletom Vermelho</h3>
      <p>R$ 120,00</p>
      <button type="submit">Adicionar ao Carrinho</button>
    </div>
  </form>

  <form method="POST">
    <input type="hidden" name="acao" value="add_carrinho">
    <input type="hidden" name="produto_id" value="2">
    <div class="produto">
      <img src="https://via.placeholder.com/150" alt="Produto 2">
      <h3>AirPods</h3>
      <p>R$ 250,00</p>
      <button type="submit">Adicionar ao Carrinho</button>
    </div>
  </form>
</section>

<footer>
  <p>¬© 2025 SHOP ON BRASIL - Todos os direitos reservados</p>
</footer>

<a href="https://wa.me/5511999999999" target="_blank" class="whatsapp-btn">
  <i class="fab fa-whatsapp"></i>
</a>

</body>
</html>
